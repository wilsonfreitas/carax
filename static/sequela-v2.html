<!DOCTYPE html>
<html lang="en">
<head>
  <title>sequela-a minimalist SQLite frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <!-- Bootstrap -->
  <link href="../static/css/bootstrap.css" rel="stylesheet">
  <style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
    overflow-y: scroll;
  }
  textarea {
    font-family: monospace;
    font-size: 150%;
  }
  </style>
  <link href="../static/css/bootstrap-responsive.css" rel="stylesheet">
  <!-- include source files here... -->
</head>

<body>
	
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container-fluid">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">Sequela</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
          <form class="navbar-form pull-right" onsubmit="return checkDatabase(this.path.value);">
            <input class="span8" type="text" placeholder="Path to database" id="path">
            <button type="submit" class="btn">Connect to database</button>
          </form>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

  <div class="container-fluid">

    <div class="row-fluid">
      <div class="well span3 sidebar-nav">
        <h4>Database info</h4>
        <div id='database-info'></div>
      </div>
      <div class="span9">
        <div class="tabbable"> <!-- Only required for left/right tabs -->
          <ul class="nav nav-tabs" id="myTab">
            <li><a href="#tab1" data-toggle="tab">Execute SQL</a></li>
            <li><a href="#tab2" data-toggle="tab">Table info</a></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane" id="tab1">
              <div class="row-fluid">
                <h4>SQL statements:</h4>
                <textarea name="Name" rows="10" class="span12"></textarea>
                <button type="submit" class="btn btn-block btn-large btn-primary">
                  Execute SQL</button>
              </div>
              <div class="row-fluid">
                <h4>Results:</h4>
                <div class="well">
                </div>
              </div>
            </div>
            <div class="tab-pane" id="tab2">
              <div class="row-fluid" id='table-info'>
                <!-- table-info: information about table structure -->
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    <hr>
    <!-- <footer>
      <p>Sequela is a free software brought by Wilson Freitas
        <br>&copy; Wilson Freitas 2013</p>
    </footer> -->
  </div> <!-- /container -->

  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="../static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../static/js/marajax.js"></script>
  <script type="text/javascript" src="../static/js/sequela-v2.js"></script>
  <script type="text/javascript" charset="utf-8">
  // The following statement sets the first tab to appear.
  // 
  $(function () {
    $('#myTab li:eq(0) a').tab('show');
  });

  var identity = function identity(x) {
      return x;
  };

  function DescriptionList(content) {
    var that = {}, dt, dd,
      dl = document.createElement('dl');

    content.forEach(function (o) {
      var dt = document.createElement('dt'), dd = document.createElement('dd');
      decorate = o.decorate || identity;
      dt.appendChild(document.createTextNode(o.label));
      dd.appendChild(decorate(document.createTextNode(o.text)));
      dl.appendChild(dt);
      dl.appendChild(dd);
    });

    that.getElement = function () {
      return dl;
    };
    return that;
  }

  function TableInfoDiv(tableInfo) {
    var that = {}, div = document.createElement('div');
    div.className = 'well';
    div.appendChild(DescriptionList([
      { label: 'Name:', text: tableInfo.name },
      { label: 'Type:', text: tableInfo.type },
      { label: 'SQL:', text: tableInfo.sql , decorate: function (e) {
        var code = document.createElement('pre');
        // code.className = 'pre-scrollable';
        code.appendChild(e)
        return code;
      }},
    ]).getElement());
    that.getElement = function () {
      return div;
    }
    return that;
  }

  function NavList(entities, createLink) {
    var that = {}, i, j, inEl,
      list = document.createElement('ul');
    createLink = createLink || function (x) {
      return document.createTextNode(x);
    };
    list.className = 'nav nav-list';

    for (i in entities) {
      inEl = document.createElement('li');
      inEl.className = 'nav-header';
      inEl.innerHTML = i;
      list.appendChild(inEl);
      entities[i].forEach(function (o) {
        inEl = document.createElement('li');
        inEl.appendChild(createLink(o));
        list.appendChild(inEl);
      });
    }

    that.getElement = function () {
      return list;
    };

    return that;
  }

  function Link(text, href, onclick) {
    var that = {},
      a = document.createElement('a');
    a.href = href;
    a.onclick = onclick;
    a.title = text;
    a.appendChild(document.createTextNode(text));
    that.getElement = function () {
      return a;
    };
    return that;
  }
  
  function createNavListLink(o) {
    return Link(o.name, '#', function () {
      var div = document.getElementById('table-info');
      while (div.hasChildNodes()) {
          div.removeChild(div.lastChild);
      }
      div.appendChild(TableInfoDiv(o).getElement());
      $('#myTab li:eq(1) a').tab('show');
    }).getElement();
  }

  var checkDatabase = function checkDatabase(database) {
    var dbi = sequela.createDatabaseInfo(database);

    when(dbi.checked, function () {
      var div = document.getElementById('database-info');
      while (div.hasChildNodes()) {
          div.removeChild(div.lastChild);
      }
      var entities = {};
      dbi.entities.forEach(function (o) {
        if (typeof entities[o.type] === 'undefined') {
          entities[o.type] = [o];
        } else {
          entities[o.type].push(o);
        }
      });
      var navList = new NavList(entities, createNavListLink);
      div.appendChild(navList.getElement());
    });

    return false; // don't submit form
  }
  
  function when(pred, func, counter) {
    counter = counter || 0;
    counter += 1;
    window.setTimeout(function () {
      if (pred()) {
        func();
      } else {
        if (counter == 100) {
          return;
        }
        when(pred, func, counter);
      }
    }, 10);
  }
  
  String.prototype.supplant = function (o) {
    return this.replace(/{([^{}]*)}/g,
      function (a, b) {
        var r = o[b];
        return typeof r === 'string' || typeof r === 'number' ? r : a;
      }
    );
  }

  Array.prototype.unique = function() {
    var o = {}, i, l = this.length, r = [];
    for(i=0; i<l;i+=1) o[this[i]] = this[i];
    for(i in o) r.push(o[i]);
    return r;
  };
  
  // return (function () { alert(this.path.value); return false; }());
  </script>
</body>
</html>
