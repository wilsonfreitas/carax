<!DOCTYPE html>
<html lang="en">
<head>
  <title>sequela-a minimalist SQLite frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <!-- Bootstrap -->
  <link href="../static/css/bootstrap.css" rel="stylesheet">
  <style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
  </style>
  <link href="../static/css/bootstrap-responsive.css" rel="stylesheet">
  <!-- include source files here... -->
</head>

<body>
	
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container-fluid">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">Sequela</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
          <form class="navbar-form pull-right" onsubmit="return checkDatabase(this.path.value);">
            <input class="span8" type="text" placeholder="Path to database" id="path">
            <button type="submit" class="btn">Connect to database</button>
          </form>
        </div><!--/.nav-collapse -->
      </div>
    </div>
  </div>

  <div class="container-fluid">

    <div class="row-fluid">
      <div class="well span3 sidebar-nav">
        <h4>Database info</h4>
        <div id='database-info'></div>
      </div>
      <div class="span9">
        <div class="tabbable"> <!-- Only required for left/right tabs -->
          <ul class="nav nav-tabs" id="myTab">
            <li><a href="#tab1" data-toggle="tab">Execute SQL</a></li>
            <li><a href="#tab2" data-toggle="tab">Table info</a></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane" id="tab1">
              <div class="row-fluid">
                <h4>SQL statements:</h4>
                <textarea name="Name" class="span12" style="font-family: monospace"></textarea>
                <button type="submit" class="btn">Execute SQL</button>
              </div>
              <div class="row-fluid">
                <h4>Results:</h4>
                <div class="well">
                </div>
              </div>
            </div>
            <div class="tab-pane" id="tab2">
              <div class="row-fluid" id='table-info'>
                <div class="well">
                  <dl>
                    <dt>Name:</dt>
                    <dd>stocks</dd>
                    <dt>Type:</dt>
                    <dd>table</dd>
                    <dt>SQL:</dt>
                    <dd> <code>CREATE TABLE stocks (date text, trans text, symbol text, qty real, price real)</code> </dd>
                    <dt>Count:</dt>
                    <dd>1</dd>
                  </dl>
                </div>
              </div>
              <div class="row-fluid">
                <table class="table table-condensed">
                <thead><tr><th class="first-col-head">N</th><th>CID</th><th>NAME</th><th>TYPE</th><th>NOTNULL</th><th>DFLT_VALUE</th><th>PK</th></tr></thead><tbody><tr><td class="first-col-body">1</td><td>0</td><td>date</td><td>text</td><td>0</td><td></td><td>0</td></tr><tr><td class="first-col-body">2</td><td>1</td><td>trans</td><td>text</td><td>0</td><td></td><td>0</td></tr><tr><td class="first-col-body">3</td><td>2</td><td>symbol</td><td>text</td><td>0</td><td></td><td>0</td></tr><tr><td class="first-col-body">4</td><td>3</td><td>qty</td><td>real</td><td>0</td><td></td><td>0</td></tr><tr><td class="first-col-body">5</td><td>4</td><td>price</td><td>real</td><td>0</td><td></td><td>0</td></tr></tbody></table>
              </div> 
            </div>
          </div>
        </div>
        
      </div>
    </div>
    <hr>
    <footer>
      <p>Sequela is a free software brought by Wilson Freitas
        <br>&copy; Wilson Freitas 2013</p>
    </footer>
  </div> <!-- /container -->

  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="../static/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../static/js/marajax.js"></script>
  <script type="text/javascript" src="../static/js/sequela-v2.js"></script>
  <script type="text/javascript" charset="utf-8">
  // The following statement sets the first tab to appear.
  // 
  $(function () {
    $('#myTab li:eq(0) a').tab('show');
  });

  function TableInfoDiv(tableInfo) {
    var that = {}, dt, dd,
      div = document.createElement('div'),
      dl = document.createElement('dl');
    div.className = 'well';
    div.appendChild(dl);
    // Name:
    dt = document.createElement('dt');
    dt.appendChild(document.createTextNode('Name:'));
    dd = document.createElement('dd');
    dd.appendChild(document.createTextNode(tableInfo.name));
    dl.appendChild(dt);
    dl.appendChild(dd);
    // Type:
    dt = document.createElement('dt');
    dt.appendChild(document.createTextNode('Type:'));
    dd = document.createElement('dd');
    dd.appendChild(document.createTextNode(tableInfo.type));
    dl.appendChild(dt);
    dl.appendChild(dd);
    // SQL:
    dt = document.createElement('dt');
    dt.appendChild(document.createTextNode('Type:'));
    dd = document.createElement('dd');
    dd.appendChild(document.createTextNode(tableInfo.sql));
    dl.appendChild(dt);
    dl.appendChild(dd);
    //
    that.getElement = function () {
      return div;
    }
    return that;
  }

  function NavList(entities, createLink) {
    var that = {}, i, j, inEl,
      list = document.createElement('ul');
    createLink = createLink || function (x) {
      return document.createTextNode(x);
    };
    list.className = 'nav nav-list';

    for (i in entities) {
      inEl = document.createElement('li');
      inEl.className = 'nav-header';
      inEl.innerHTML = i;
      list.appendChild(inEl);
      entities[i].forEach(function (o) {
        inEl = document.createElement('li');
        inEl.appendChild(createLink(o));
        list.appendChild(inEl);
      });
    }

    that.getElement = function () {
      return list;
    };

    return that;
  }

  function Link(text, href, onclick) {
    var that = {},
      a = document.createElement('a');
    a.href = href;
    a.onclick = onclick;
    a.title = text;
    a.appendChild(document.createTextNode(text));
    that.getElement = function () {
      return a;
    };
    return that;
  }
  
  function createNavListLink(o) {
    return Link(o.name, '#', function () {
      var div = document.getElementById('table-info');
      while (div.hasChildNodes()) {
          div.removeChild(div.lastChild);
      }
      div.appendChild(TableInfoDiv(o).getElement());
      $('#myTab li:eq(1) a').tab('show');
    }).getElement();
  }

  var checkDatabase = function checkDatabase(database) {
    var dbi = sequela.createDatabaseInfo(database);

    when(dbi.checked, function () {
      var div = document.getElementById('database-info');
      while (div.hasChildNodes()) {
          div.removeChild(div.lastChild);
      }
      var entities = {};
      dbi.entities.forEach(function (o) {
        if (typeof entities[o.type] === 'undefined') {
          entities[o.type] = [o];
        } else {
          entities[o.type].push(o);
        }
      });
      var navList = new NavList(entities, createNavListLink);
      div.appendChild(navList.getElement());
    });

    return false; // don't submit form
  }
  
  function when(pred, func, counter) {
    counter = counter || 0;
    counter += 1;
    window.setTimeout(function () {
      if (pred()) {
        func();
      } else {
        if (counter == 100) {
          return;
        }
        when(pred, func, counter);
      }
    }, 10);
  }
  
  String.prototype.supplant = function (o) {
    return this.replace(/{([^{}]*)}/g,
      function (a, b) {
        var r = o[b];
        return typeof r === 'string' || typeof r === 'number' ? r : a;
      }
    );
  }

  Array.prototype.unique = function() {
    var o = {}, i, l = this.length, r = [];
    for(i=0; i<l;i+=1) o[this[i]] = this[i];
    for(i in o) r.push(o[i]);
    return r;
  };
  
  // return (function () { alert(this.path.value); return false; }());
  </script>
</body>
</html>
